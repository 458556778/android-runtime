<?xml version="1.0" encoding="UTF-8"?>
<project name="custom_logic_for_metadata_generation" default="-post-compile">
    
    <property name="path_to_metadata" value="./assets/metadata"/>
    <property name="generatedJarLocation" value="./dist" />
	<property name="sdk_warning" value="Currently runAntRelease step in grunt file includes an ant custom_rules.xml step which generates latest greatest metadata... Currently we generate metadata using the target sdk declared in the AndroidManifest file and if the sdk is missing the build will fail" />
	
	 <!-- GET MIN SDK VERSION FROM MANIFEST AND SAVE IN PROP "minSdkVersion" -->
	<target name="retrieve_min_version_from_manifest">
	
		<xmlproperty file="./AndroidManifest.xml" collapseAttributes="true"/>
		
	    <property name="relative_path_to_min_declared_sdk" value="platforms/android-${manifest.uses-sdk.android:minSdkVersion}/android.jar" />
		
	</target>
	
	<!-- REPLACE MIN SDK JAR WITH ONE ON USER MACHINE -->
	<target name="copy_target_sdk" depends="retrieve_min_version_from_manifest">
		<echo message="WARNING: ${sdk_warning}" />
		
	   	<copy file="${sdk.dir}/${relative_path_to_min_declared_sdk}" todir="${generatedJarLocation}"/>
	   	
	</target>
	
	<target name="copy_ns_jar" >
	
		<copy file="./../dist/framework/libs/nativescript.jar" todir="./dist"/>
		
	</target>
	
	<target name="copy_support_jar" >
	
		<copy file="./../dist/framework/libs/android-support-v4.jar" todir="./dist"/>
		
	</target>
	
	<target name="generate_jar_from_classes">
	
		  <jar destfile="${generatedJarLocation}/test-app.jar" basedir="./bin/classes"/>
		  
	</target>
	
	<target name="delete_old_metadata">
	
		 <delete>
		 
		  	<fileset dir="${path_to_metadata}" includes="**/*.dat"/>
			
		</delete>
		
	</target>
	
	
    <!-- PASS JARS TO METADATA GENERATOR -->
	<!-- currently we generate metadata using the target sdk declared in the AndroidManifest file -->
    <target name="generate_metadata_from_given_jars" depends="copy_target_sdk, copy_ns_jar, copy_support_jar, generate_jar_from_classes, delete_old_metadata">
        
		<java classname="com.telerik.metadata.Generator">
				 
			<arg value="./dist"></arg>
			
			<arg value="${path_to_metadata}"></arg>
			
			<classpath>
				<pathelement location="./../node_modules/tns-android-metadata-generator/classes"/>
			</classpath>
			
		</java> 
		
		<echo message=" --------- created new metadata and moved it to assets/metadata" />
		
    </target>
	
	
	<target name="delete_all_files_in_dist" depends="generate_metadata_from_given_jars">
	
		<delete>
			<fileset dir="${generatedJarLocation}" includes="**/*.jar"/>
		</delete>
		
	</target>
        
    <target name="-post-compile" depends="delete_all_files_in_dist">
		
	</target>
    
</project> 